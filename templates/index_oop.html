{% extends "base.html" %}

{% block title %}VoiceForge 2.0 - é¢å‘å¯¹è±¡ç‰ˆæœ¬{% endblock %}

{% block head %}
<style>
    :root {
        --primary-color: #6366f1;
        --primary-hover: #4f46e5;
        --bg-color: #f8fafc;
        --card-bg: #ffffff;
        --text-color: #1e293b;
        --text-muted: #64748b;
        --border-color: #e2e8f0;
        --success-color: #10b981;
        --error-color: #ef4444;
        --warning-color: #f59e0b;
    }
    
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    .main-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
    }
    
    .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        border: none;
        margin-bottom: 20px;
    }
    
    .card-header {
        background: transparent;
        border-bottom: 1px solid var(--border-color);
        padding: 20px 24px;
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .card-header i {
        color: var(--primary-color);
    }
    
    .card-body {
        padding: 24px;
    }
    
    .form-control, .form-select {
        border: 2px solid var(--border-color);
        border-radius: 10px;
        padding: 12px 16px;
        font-size: 0.95rem;
        transition: all 0.2s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
    }
    
    .btn-primary {
        background: var(--primary-color);
        border-color: var(--primary-color);
        border-radius: 10px;
        padding: 12px 24px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
        background: var(--primary-hover);
        border-color: var(--primary-hover);
        transform: translateY(-1px);
    }
    
    .loading-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .version-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="version-badge">
        VoiceForge 2.0 - é¢å‘å¯¹è±¡ç‰ˆæœ¬
    </div>
    
    <div class="header">
        <h1><i class="bi bi-mic-fill"></i> VoiceForge</h1>
        <p>ğŸ™ï¸ ä¸“ä¸šçš„è¯­éŸ³åˆæˆå·¥åŠ - é«˜è´¨é‡çš„æ–‡æœ¬è½¬è¯­éŸ³å¹³å° (é¢å‘å¯¹è±¡é‡æ„ç‰ˆ)</p>
        <div class="d-flex justify-content-center gap-4 mt-3">
            <div class="badge bg-light text-dark"><i class="bi bi-check-circle"></i> OpenAI å…¼å®¹</div>
            <div class="badge bg-light text-dark"><i class="bi bi-lightning"></i> SSE æµå¼</div>
            <div class="badge bg-light text-dark"><i class="bi bi-globe"></i> å¤šè¯­è¨€æ”¯æŒ</div>
            <div class="badge bg-warning text-dark"><i class="bi bi-code-slash"></i> é¢å‘å¯¹è±¡</div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Settings -->
        <div class="col-lg-5 mb-4">
            <!-- API Settings -->
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-gear"></i> API è®¾ç½®
                </div>
                <div class="card-body">
                    <form id="apiSettingsForm" onsubmit="return false;">
                        <div class="mb-3">
                            <label for="api_key" class="form-label">API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="api_key" name="api_key" value="{{ default_api_key }}" placeholder="è¾“å…¥ API Key" autocomplete="current-password">
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility()">
                                    <i class="bi bi-eye" id="apiKeyToggleIcon"></i>
                                </button>
                            </div>
                            <div class="form-text">ä½¿ç”¨ä»»æ„å­—ç¬¦ä¸²ä½œä¸ºå¯†é’¥ï¼ˆæ— éœ€çœŸå® OpenAI å¯†é’¥ï¼‰</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="model" class="form-label">æ¨¡å‹</label>
                            <select class="form-select" id="model" name="model">
                                {% for m in models %}
                                <option value="{{ m }}" {% if m == default_model %}selected{% endif %}>{{ m }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">tts-1: æ ‡å‡†è´¨é‡ | tts-1-hd: é«˜æ¸…è´¨é‡</div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary flex-grow-1" id="loadModelsBtn">
                                <i class="bi bi-arrow-clockwise"></i> åŠ è½½æ¨¡å‹
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="testConnectionBtn">
                                <i class="bi bi-plug"></i> æµ‹è¯•è¿æ¥
                            </button>
                        </div>
                    </form>
                    <div id="connectionStatus" class="mt-2"></div>
                </div>
            </div>
            
            <!-- Voice Settings -->
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-mic"></i> è¯­éŸ³è®¾ç½®
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="voice" class="form-label">é€‰æ‹©è¯­éŸ³</label>
                        <select class="form-select" id="voice">
                            {% for category, voices in voices_by_language.items() %}
                            <optgroup label="{{ category }}">
                                {% for voice in voices %}
                                <option value="{{ voice }}" {% if voice == default_voice %}selected{% endif %}>{{ voice }}</option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">æˆ–è¾“å…¥è‡ªå®šä¹‰è¯­éŸ³</label>
                        <input type="text" class="form-control" id="custom_voice" placeholder="ä¾‹å¦‚: en-US-AvaNeural">
                        <div class="form-text">æ”¯æŒä»»æ„ edge-tts è¯­éŸ³åç§°</div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary flex-grow-1" id="loadVoicesBtn">
                            <i class="bi bi-arrow-clockwise"></i> åŠ è½½æ‰€æœ‰è¯­éŸ³
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="previewVoiceBtn">
                            <i class="bi bi-play-circle"></i> è¯•å¬
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Audio Settings -->
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-sliders"></i> éŸ³é¢‘è®¾ç½®
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">éŸ³é¢‘æ ¼å¼</label>
                        <div class="d-flex gap-2 flex-wrap">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="response_format" id="format_mp3" value="mp3" checked>
                                <label class="form-check-label" for="format_mp3">mp3</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="response_format" id="format_opus" value="opus">
                                <label class="form-check-label" for="format_opus">opus</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="response_format" id="format_aac" value="aac">
                                <label class="form-check-label" for="format_aac">aac</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="response_format" id="format_flac" value="flac">
                                <label class="form-check-label" for="format_flac">flac</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">æ’­æ”¾é€Ÿåº¦: <span id="speedValue">1.0x</span></label>
                        <div class="d-flex align-items-center gap-2">
                            <small class="text-muted">0.25x</small>
                            <input type="range" class="form-range flex-grow-1" id="speed" min="0.25" max="4.0" step="0.25" value="1.0">
                            <small class="text-muted">4.0x</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="stream_mode">
                            <label class="form-check-label" for="stream_mode">
                                <i class="bi bi-lightning-charge"></i> æµå¼ä¼ è¾“æ¨¡å¼
                            </label>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> å¼€å¯åè¾¹ä¸‹è½½è¾¹æ’­æ”¾ï¼Œæ— éœ€ç­‰å¾…å®Œæˆã€‚é•¿æ–‡æœ¬å»ºè®®å¼€å¯ï¼Œå¯æå‰å¬åˆ°è¯­éŸ³ã€‚
                        </div>
                    </div>
                    
                    <div class="mb-0">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="auto_download">
                            <label class="form-check-label" for="auto_download">
                                <i class="bi bi-download"></i> ç”Ÿæˆåè‡ªåŠ¨ä¸‹è½½
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Text Input and Output -->
        <div class="col-lg-7">
            <!-- Text Input -->
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-pencil"></i> æ–‡æœ¬è¾“å…¥
                </div>
                <div class="card-body">
                    <!-- æ–‡æœ¬è¾“å…¥é€‰é¡¹å¡ -->
                    <ul class="nav nav-tabs mb-3" id="inputTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-pane" type="button" role="tab">
                                <i class="bi bi-pencil"></i> ç›´æ¥è¾“å…¥
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-pane" type="button" role="tab">
                                <i class="bi bi-file-text"></i> ä¸Šä¼ æ–‡ä»¶
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-pane" type="button" role="tab">
                                <i class="bi bi-link"></i> ç½‘ç»œæ–‡æœ¬
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="inputTabContent">
                        <!-- ç›´æ¥è¾“å…¥ -->
                        <div class="tab-pane fade show active" id="text-pane" role="tabpanel">
                            <div class="mb-3">
                                <textarea class="form-control" id="input_text" rows="6" placeholder="åœ¨æ­¤è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬...">ä½ å¥½ï¼æ¬¢è¿ä½¿ç”¨ VoiceForge 2.0 é¢å‘å¯¹è±¡ç‰ˆæœ¬ã€‚è¿™æ˜¯ä¸€ä¸ªé‡æ„åçš„ä¸“ä¸šè¯­éŸ³åˆæˆå·¥åŠã€‚</textarea>
                            </div>
                        </div>
                        
                        <!-- æ–‡ä»¶ä¸Šä¼  -->
                        <div class="tab-pane fade" id="file-pane" role="tabpanel">
                            <div class="mb-3">
                                <input class="form-control" type="file" id="fileInput" accept=".txt,.md,.srt">
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i> æ”¯æŒ .txtã€.mdã€.srt æ ¼å¼æ–‡ä»¶
                                </div>
                            </div>
                            <div id="filePreview" class="mb-3" style="display: none;">
                                <label class="form-label">æ–‡ä»¶å†…å®¹é¢„è§ˆï¼š</label>
                                <textarea class="form-control" id="fileContent" rows="6" readonly></textarea>
                            </div>
                        </div>
                        
                        <!-- ç½‘ç»œæ–‡æœ¬ -->
                        <div class="tab-pane fade" id="url-pane" role="tabpanel">
                            <div class="mb-3">
                                <div class="input-group">
                                    <input type="url" class="form-control" id="urlInput" placeholder="è¾“å…¥æ–‡æœ¬æ–‡ä»¶çš„ç½‘ç»œåœ°å€ï¼Œå¦‚ï¼šhttp://example.com/text.txt">
                                    <button class="btn btn-outline-secondary" type="button" id="fetchUrlBtn">
                                        <i class="bi bi-download"></i> è·å–
                                    </button>
                                </div>
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i> æ”¯æŒ HTTP/HTTPS é“¾æ¥çš„æ–‡æœ¬æ–‡ä»¶
                                </div>
                            </div>
                            <div id="urlPreview" class="mb-3" style="display: none;">
                                <label class="form-label">è·å–çš„å†…å®¹ï¼š</label>
                                <textarea class="form-control" id="urlContent" rows="6" readonly></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="text-muted">
                            <span id="charCount">å­—ç¬¦: 47</span>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="button" class="btn btn-primary btn-lg" id="generateBtn">
                            <i class="bi bi-play-fill"></i> ç”Ÿæˆè¯­éŸ³ (é¢å‘å¯¹è±¡ç‰ˆ)
                        </button>
                    </div>
                    <div id="generateStatus" class="mt-2"></div>
                </div>
            </div>
            
            <!-- Audio Output -->
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-volume-up"></i> éŸ³é¢‘è¾“å‡º
                </div>
                <div class="card-body">
                    <div id="audioOutput" class="text-center p-4">
                        <i class="bi bi-music-note-beamed text-muted" style="font-size: 2rem;"></i>
                        <p class="text-muted mt-2 mb-0">ç”Ÿæˆçš„éŸ³é¢‘å°†åœ¨æ­¤å¤„æ’­æ”¾</p>
                        <small class="text-muted">ä½¿ç”¨é¢å‘å¯¹è±¡æ¶æ„çš„éŸ³é¢‘ç®¡ç†å™¨</small>
                    </div>
                    
                    <div class="d-flex gap-2 mt-3" id="audioActions" style="display: none !important;">
                        <button type="button" class="btn btn-secondary flex-grow-1" id="downloadBtn" onclick="downloadAudio()">
                            <i class="bi bi-download"></i> ä¸‹è½½éŸ³é¢‘
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="copyLinkBtn" onclick="copyAudioUrl()">
                            <i class="bi bi-link-45deg"></i> å¤åˆ¶é“¾æ¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="text-center text-white mt-4">
        <p>VoiceForge 2.0 - é¢å‘å¯¹è±¡é‡æ„ç‰ˆæœ¬ | åŸºäº Edge-TTS çš„ OpenAI å…¼å®¹ TTS API</p>
        <small>é€‚ç”¨äºä¸ªäººä½¿ç”¨ | GPL-3.0 è®¸å¯è¯ | æ¶æ„ï¼šåˆ†å±‚è®¾è®¡ + æ¨¡å—åŒ– + é¢å‘å¯¹è±¡</small>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ç®€å•çš„API Keyå¯è§æ€§åˆ‡æ¢åŠŸèƒ½
function toggleApiKeyVisibility() {
    const input = document.getElementById('api_key');
    const icon = document.getElementById('apiKeyToggleIcon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'bi bi-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'bi bi-eye';
    }
}

// å­—ç¬¦è®¡æ•°æ›´æ–°
function updateCharCount() {
    const textInput = document.getElementById('input_text');
    const charCountEl = document.getElementById('charCount');
    
    if (textInput && charCountEl) {
        const count = textInput.value.length;
        charCountEl.textContent = `å­—ç¬¦: ${count}`;
    }
}

// ä¸‹è½½éŸ³é¢‘åŠŸèƒ½
function downloadAudio() {
    if (!window.currentAudioUrl) {
        if (window.voiceForgeApp) {
            window.voiceForgeApp.notificationManager.show('æ²¡æœ‰å¯ä¸‹è½½çš„éŸ³é¢‘', 'warning');
        } else {
            alert('æ²¡æœ‰å¯ä¸‹è½½çš„éŸ³é¢‘');
        }
        return;
    }
    
    try {
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
        const filename = `speech_${timestamp}.mp3`;
        
        const a = document.createElement('a');
        a.href = window.currentAudioUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        if (window.voiceForgeApp) {
            window.voiceForgeApp.notificationManager.show('éŸ³é¢‘ä¸‹è½½å·²å¼€å§‹', 'success');
        }
    } catch (error) {
        console.error('ä¸‹è½½å¤±è´¥:', error);
        if (window.voiceForgeApp) {
            window.voiceForgeApp.notificationManager.show('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        } else {
            alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
}

// å¤åˆ¶éŸ³é¢‘é“¾æ¥åŠŸèƒ½
function copyAudioUrl() {
    if (!window.currentAudioUrl) {
        if (window.voiceForgeApp) {
            window.voiceForgeApp.notificationManager.show('æ²¡æœ‰å¯å¤åˆ¶çš„é“¾æ¥', 'warning');
        } else {
            alert('æ²¡æœ‰å¯å¤åˆ¶çš„é“¾æ¥');
        }
        return;
    }
    
    navigator.clipboard.writeText(window.currentAudioUrl).then(() => {
        if (window.voiceForgeApp) {
            window.voiceForgeApp.notificationManager.show('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        } else {
            alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }
    }).catch(() => {
        if (window.voiceForgeApp) {
            window.voiceForgeApp.notificationManager.show('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
        } else {
            alert('å¤åˆ¶å¤±è´¥');
        }
    });
}

// æ›´æ–°é€Ÿåº¦æ˜¾ç¤º
function updateSpeedValue() {
    const speed = document.getElementById('speed').value;
    document.getElementById('speedValue').textContent = speed + 'x';
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    updateCharCount();
    updateSpeedValue();
    
    const textInput = document.getElementById('input_text');
    if (textInput) {
        textInput.addEventListener('input', updateCharCount);
    }
    
    const speedSlider = document.getElementById('speed');
    if (speedSlider) {
        speedSlider.addEventListener('input', updateSpeedValue);
    }
    
    console.log('VoiceForge 2.0 é¢å‘å¯¹è±¡ç‰ˆæœ¬é¡µé¢åŠ è½½å®Œæˆ');
    console.log('å®Œæ•´çš„æ¨¡å—åŒ–åŠŸèƒ½å·²å®ç°ï¼ŒåŒ…æ‹¬æµå¼ä¼ è¾“æ”¯æŒ');
});
</script>
{% endblock %}
