<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceForge - ä¸“ä¸šè¯­éŸ³åˆæˆå·¥åŠ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 20px;
        }
        
        .card-header {
            background: transparent;
            border-bottom: 1px solid var(--border-color);
            padding: 20px 24px;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-header i {
            color: var(--primary-color);
        }
        
        .card-body {
            padding: 24px;
        }
        
        .form-label {
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 8px;
        }
        
        .form-control, .form-select {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .form-text {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .btn-primary {
            background: var(--primary-color);
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            border: none;
            color: var(--text-color);
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 500;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
            color: var(--text-color);
        }
        
        .btn-outline-primary {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 500;
        }
        
        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .speed-slider {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .speed-slider input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .speed-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .speed-slider input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        .speed-value {
            min-width: 50px;
            text-align: center;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .audio-player-container {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .audio-player-container audio {
            width: 100%;
            border-radius: 8px;
        }
        
        .status-message {
            padding: 12px 16px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }
        
        .status-message.success {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
            display: block;
        }
        
        .status-message.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
            display: block;
        }
        
        .status-message.loading {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .voice-group-label {
            font-weight: 600;
            color: var(--primary-color);
            padding: 8px 12px;
            background: #f1f5f9;
        }
        
        .tabs-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .tab-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .tab-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .feature-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: #eff6ff;
            color: #3b82f6;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
        }
        
        .info-item label {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: block;
            margin-bottom: 5px;
        }
        
        .info-item span {
            font-weight: 600;
            color: var(--text-color);
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #bfdbfe;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .stream-progress {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #bfdbfe;
        }
        
        .stream-progress .progress {
            background: #e0e7ff;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .stream-progress .progress-bar {
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
        }
        
        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #fafbfc;
        }
        
        .upload-zone:hover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.05);
        }
        
        .upload-zone.drag-over {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
            transform: scale(1.01);
        }
        
        .upload-zone-content i {
            font-size: 2.5rem;
            color: var(--primary-color);
            opacity: 0.7;
        }
        
        .upload-zone-content p {
            margin: 10px 0 5px;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .upload-zone-content small {
            color: var(--text-muted);
            opacity: 0.8;
        }
        
        .input-mode-tabs {
            display: flex;
            gap: 10px;
            background: #f1f5f9;
            padding: 6px;
            border-radius: 10px;
        }
        
        .input-mode-tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .input-mode-tab:hover {
            color: var(--text-color);
        }
        
        .input-mode-tab.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .uploaded-file-info {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #a7f3d0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .file-preview {
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }
        
        .file-preview-content {
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-break: break-all;
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .file-preview-content.expanded {
            max-height: 400px;
        }
        
        .text-stats .badge {
            font-weight: 500;
            padding: 6px 10px;
        }
        
        .voice-preview-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .row-cols-custom > * {
            flex: 0 0 auto;
        }
        
        .format-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .format-option {
            flex: 1;
            min-width: 80px;
        }
        
        .format-option input[type="radio"] {
            display: none;
        }
        
        .format-option label {
            display: block;
            padding: 10px 15px;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .format-option input[type="radio"]:checked + label {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
        }
        
        .format-option label:hover {
            border-color: var(--primary-color);
        }
        
        .history-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .history-item audio {
            flex: 1;
        }
        
        .history-item .history-text {
            flex: 2;
            font-size: 0.9rem;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .history-item .history-actions {
            display: flex;
            gap: 5px;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .card-body {
                padding: 16px;
            }
            
            .format-option {
                min-width: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="bi bi-soundwave"></i> VoiceForge</h1>
            <p>ğŸ™ï¸ ä¸“ä¸šçš„è¯­éŸ³åˆæˆå·¥åŠ - é«˜è´¨é‡çš„æ–‡æœ¬è½¬è¯­éŸ³å¹³å°</p>
            <div class="d-flex justify-content-center gap-2 mt-3">
                <span class="feature-badge"><i class="bi bi-check-circle"></i> OpenAI å…¼å®¹</span>
                <span class="feature-badge"><i class="bi bi-lightning"></i> SSE æµå¼</span>
                <span class="feature-badge"><i class="bi bi-globe"></i> å¤šè¯­è¨€æ”¯æŒ</span>
            </div>
        </div>
        
        <div class="row">
            <!-- Left Column: Settings -->
            <div class="col-lg-5 mb-4">
                <!-- API Settings -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-gear"></i> API è®¾ç½®
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="api_key" class="form-label">API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="api_key" value="{{ default_api_key }}" placeholder="è¾“å…¥ API Key">
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility()">
                                    <i class="bi bi-eye" id="apiKeyToggleIcon"></i>
                                </button>
                            </div>
                            <div class="form-text">ä½¿ç”¨ä»»æ„å­—ç¬¦ä¸²ä½œä¸ºå¯†é’¥ï¼ˆæ— éœ€çœŸå® OpenAI å¯†é’¥ï¼‰</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="model" class="form-label">æ¨¡å‹</label>
                            <select class="form-select" id="model">
                                {% for m in models %}
                                <option value="{{ m }}" {% if m == default_model %}selected{% endif %}>{{ m }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">tts-1: æ ‡å‡†è´¨é‡ | tts-1-hd: é«˜æ¸…è´¨é‡</div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary flex-grow-1" onclick="loadModels()">
                                <i class="bi bi-arrow-clockwise"></i> åŠ è½½æ¨¡å‹
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="testConnection()">
                                <i class="bi bi-plug"></i> æµ‹è¯•è¿æ¥
                            </button>
                        </div>
                        <div id="connectionStatus" class="status-message"></div>
                    </div>
                </div>
                
                <!-- Voice Settings -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-mic"></i> è¯­éŸ³è®¾ç½®
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="voice" class="form-label">é€‰æ‹©è¯­éŸ³</label>
                            <select class="form-select" id="voice">
                                {% for group, voices in voices_by_language.items() %}
                                <optgroup label="{{ group }}">
                                    {% for v in voices %}
                                    <option value="{{ v }}" {% if v == default_voice %}selected{% endif %}>{{ v }}</option>
                                    {% endfor %}
                                </optgroup>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">æˆ–è¾“å…¥è‡ªå®šä¹‰è¯­éŸ³</label>
                            <input type="text" class="form-control" id="custom_voice" placeholder="ä¾‹å¦‚: en-US-AvaNeural">
                            <div class="form-text">æ”¯æŒä»»æ„ edge-tts è¯­éŸ³åç§°</div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary flex-grow-1" onclick="loadVoices()">
                                <i class="bi bi-arrow-clockwise"></i> åŠ è½½æ‰€æœ‰è¯­éŸ³
                            </button>
                            <button type="button" class="btn btn-outline-primary voice-preview-btn" onclick="previewVoice()">
                                <i class="bi bi-play-circle"></i> è¯•å¬
                            </button>
                        </div>
                        <div id="voicePreviewPlayer" class="audio-player-container" style="display: none;"></div>
                    </div>
                </div>
                
                <!-- Audio Settings -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-sliders"></i> éŸ³é¢‘è®¾ç½®
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label">éŸ³é¢‘æ ¼å¼</label>
                            <div class="format-options">
                                {% for fmt in formats %}
                                <div class="format-option">
                                    <input type="radio" name="response_format" id="format_{{ fmt }}" value="{{ fmt }}" {% if fmt == default_format %}checked{% endif %}>
                                    <label for="format_{{ fmt }}">{{ fmt }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">æ’­æ”¾é€Ÿåº¦: <span id="speedValue">{{ default_speed }}x</span></label>
                            <div class="speed-slider">
                                <span>0.25x</span>
                                <input type="range" id="speed" min="0.25" max="4.0" step="0.25" value="{{ default_speed }}">
                                <span>4.0x</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="stream_mode">
                                <label class="form-check-label" for="stream_mode">
                                    <i class="bi bi-broadcast"></i> æµå¼ä¼ è¾“æ¨¡å¼
                                </label>
                            </div>
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> å¼€å¯åè¾¹ä¸‹è½½è¾¹æ’­æ”¾ï¼Œæ— éœ€ç­‰å¾…å®Œæˆã€‚é•¿æ–‡æœ¬å»ºè®®å¼€å¯ï¼Œå¯æå‰å¬åˆ°è¯­éŸ³ã€‚
                            </div>
                        </div>
                        
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto_download">
                            <label class="form-check-label" for="auto_download">
                                <i class="bi bi-download"></i> ç”Ÿæˆåè‡ªåŠ¨ä¸‹è½½
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Text Input & Output -->
            <div class="col-lg-7">
                <!-- Text Input -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-textarea-t"></i> æ–‡æœ¬è¾“å…¥
                    </div>
                    <div class="card-body">
                        <!-- è¾“å…¥æ–¹å¼åˆ‡æ¢ -->
                        <div class="input-mode-tabs mb-3">
                            <button type="button" class="input-mode-tab active" onclick="switchInputMode('text')" id="tabText">
                                <i class="bi bi-cursor-text"></i> ç›´æ¥è¾“å…¥
                            </button>
                            <button type="button" class="input-mode-tab" onclick="switchInputMode('file')" id="tabFile">
                                <i class="bi bi-file-earmark-text"></i> ä¸Šä¼ æ–‡ä»¶
                            </button>
                            <button type="button" class="input-mode-tab" onclick="switchInputMode('url')" id="tabUrl">
                                <i class="bi bi-link-45deg"></i> ç½‘ç»œURL
                            </button>
                        </div>
                        
                        <!-- ç›´æ¥è¾“å…¥æ¨¡å¼ -->
                        <div id="textInputMode">
                            <div class="mb-3">
                                <textarea class="form-control" id="input_text" rows="10" placeholder="åœ¨æ­¤è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬...">ä½ å¥½ï¼æ¬¢è¿ä½¿ç”¨ OpenAI-Edge-TTS æ–‡æœ¬è½¬è¯­éŸ³æœåŠ¡ã€‚è¿™æ˜¯ä¸€ä¸ªå…è´¹ã€é«˜è´¨é‡çš„ TTS APIï¼Œæ”¯æŒå¤šç§è¯­è¨€å’Œè¯­éŸ³é€‰é¡¹ã€‚</textarea>
                            </div>
                        </div>
                        
                        <!-- æ–‡ä»¶ä¸Šä¼ æ¨¡å¼ -->
                        <div id="fileInputMode" style="display: none;">
                            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileUpload').click()">
                                <input type="file" id="fileUpload" accept=".txt,.md,.text,.srt,.vtt,.json" style="display: none;">
                                <div class="upload-zone-content" id="uploadZoneContent">
                                    <i class="bi bi-cloud-arrow-up"></i>
                                    <p>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                                    <small>æ”¯æŒ .txt, .md, .srt, .vtt æ ¼å¼</small>
                                </div>
                            </div>
                            
                            <!-- å·²ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯ -->
                            <div id="uploadedFileInfo" class="uploaded-file-info" style="display: none;">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-file-earmark-text text-primary" style="font-size: 1.5rem;"></i>
                                        <div>
                                            <div class="fw-medium" id="uploadedFileName">æ–‡ä»¶å</div>
                                            <small class="text-muted" id="uploadedFileSize">0 KB</small>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeUploadedFile()">
                                        <i class="bi bi-x-lg"></i> ç§»é™¤
                                    </button>
                                </div>
                            </div>
                            
                            <!-- æ–‡ä»¶å†…å®¹é¢„è§ˆ -->
                            <div id="filePreview" class="file-preview mt-3" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0"><i class="bi bi-eye"></i> å†…å®¹é¢„è§ˆ</label>
                                    <button type="button" class="btn btn-sm btn-link" onclick="toggleFullPreview()">
                                        <span id="previewToggleText">å±•å¼€å…¨éƒ¨</span>
                                    </button>
                                </div>
                                <div class="file-preview-content" id="filePreviewContent"></div>
                            </div>
                        </div>
                        
                        <!-- ç½‘ç»œURLæ¨¡å¼ -->
                        <div id="urlInputMode" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-link-45deg"></i> è¾“å…¥æ–‡æœ¬æ–‡ä»¶URL</label>
                                <div class="input-group">
                                    <input type="url" class="form-control" id="textUrl" 
                                           placeholder="https://example.com/text.txt">
                                    <button class="btn btn-primary" type="button" onclick="loadFromUrl()" id="loadUrlBtn">
                                        <i class="bi bi-download"></i> åŠ è½½
                                    </button>
                                </div>
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i> æ”¯æŒ .txt, .md, .srt ç­‰çº¯æ–‡æœ¬æ–‡ä»¶
                                </div>
                            </div>
                            
                            <!-- URLåŠ è½½çŠ¶æ€ -->
                            <div id="urlLoadStatus" style="display: none;"></div>
                            
                            <!-- URLå†…å®¹é¢„è§ˆ -->
                            <div id="urlPreview" class="file-preview mt-3" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">
                                        <i class="bi bi-eye"></i> å·²åŠ è½½å†…å®¹ 
                                        <span class="badge bg-success" id="urlCharCount">0 å­—ç¬¦</span>
                                    </label>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearUrlContent()">
                                        <i class="bi bi-x-lg"></i> æ¸…é™¤
                                    </button>
                                </div>
                                <div class="file-preview-content" id="urlPreviewContent" style="max-height: 300px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <!-- å­—ç¬¦ç»Ÿè®¡å’Œæ“ä½œ -->
                        <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
                            <div class="text-stats">
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-text-paragraph"></i> å­—ç¬¦: <span id="charCount">0</span>
                                </span>
                                <span class="badge bg-light text-dark ms-2" id="wordCountBadge" style="display: none;">
                                    <i class="bi bi-card-text"></i> è¡Œæ•°: <span id="lineCount">0</span>
                                </span>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="pasteFromClipboard()" title="ä»å‰ªè´´æ¿ç²˜è´´">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="clearText()" title="æ¸…ç©ºå†…å®¹">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary btn-lg" onclick="generateSpeech()" id="generateBtn">
                                <i class="bi bi-play-fill"></i> ç”Ÿæˆè¯­éŸ³
                            </button>
                        </div>
                        
                        <div id="generateStatus" class="status-message"></div>
                    </div>
                </div>
                
                <!-- Audio Output -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-volume-up"></i> éŸ³é¢‘è¾“å‡º
                    </div>
                    <div class="card-body">
                        <div id="audioOutput" class="audio-player-container">
                            <p class="text-muted text-center mb-0">
                                <i class="bi bi-music-note-beamed"></i> ç”Ÿæˆçš„éŸ³é¢‘å°†åœ¨æ­¤å¤„æ’­æ”¾
                            </p>
                        </div>
                        
                        <div class="d-flex gap-2 mt-3" id="audioActions" style="display: none !important;">
                            <button type="button" class="btn btn-secondary flex-grow-1" onclick="downloadAudio()">
                                <i class="bi bi-download"></i> ä¸‹è½½éŸ³é¢‘
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="copyAudioUrl()">
                                <i class="bi bi-link-45deg"></i> å¤åˆ¶é“¾æ¥
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- History -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-clock-history"></i> å†å²è®°å½•</span>
                        <button type="button" class="btn btn-sm btn-link" onclick="clearHistory()">æ¸…ç©º</button>
                    </div>
                    <div class="card-body">
                        <div id="historyList">
                            <p class="text-muted text-center mb-0">æš‚æ— å†å²è®°å½•</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API Info -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> API ä¿¡æ¯
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-link-45deg"></i> API åŸºç¡€åœ°å€</label>
                    <input type="text" class="form-control" id="apiBaseUrl" value="{{ api_base_url }}" 
                           placeholder="http://117.72.56.34:5050" oninput="updateCurlExample()">
                    <div class="form-text">å¯è‡ªå®šä¹‰APIæœåŠ¡å™¨åœ°å€</div>
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <label>API ç«¯ç‚¹</label>
                        <span><span id="apiEndpointDisplay">{{ api_base_url }}</span>/v1/audio/speech</span>
                    </div>
                    <div class="info-item">
                        <label>æ”¯æŒæ ¼å¼</label>
                        <span>{{ formats | join(', ') }}</span>
                    </div>
                    <div class="info-item">
                        <label>é€Ÿåº¦èŒƒå›´</label>
                        <span>0.25x - 4.0x</span>
                    </div>
                    <div class="info-item">
                        <label>OpenAI è¯­éŸ³</label>
                        <span>{{ openai_voices | join(', ') }}</span>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6><i class="bi bi-terminal"></i> ä½¿ç”¨ç¤ºä¾‹ (curl) <small class="text-muted">- éšé€‰é¡¹å˜åŒ–</small></h6>
                    <pre class="bg-dark text-light p-3 rounded" style="font-size: 0.85rem; overflow-x: auto;"><code id="curlExample">curl -X POST "<span id="curlBaseUrl">{{ api_base_url }}</span>/v1/audio/speech" \
  -H "Authorization: Bearer your_api_key_here" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "<span id="curlModel">tts-1</span>",
    "input": "Hello, world!",
    "voice": "<span id="curlVoice">{{ default_voice }}</span>",
    "response_format": "<span id="curlFormat">{{ default_format }}</span>",
    "speed": <span id="curlSpeed">{{ default_speed }}</span>
  }' \
  --output speech.<span id="curlExt">{{ default_format }}</span></code></pre>
                    <button class="btn btn-sm btn-outline-light mt-2" onclick="copyCurlExample()">
                        <i class="bi bi-clipboard"></i> å¤åˆ¶å‘½ä»¤
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="text-center text-white mt-4 mb-3">
            <p class="mb-1">åŸºäº Edge-TTS çš„ OpenAI å…¼å®¹ TTS API</p>
            <small class="opacity-75">é€‚ç”¨äºä¸ªäººä½¿ç”¨ | GPL-3.0 è®¸å¯è¯</small>
        </div>
    </div>
    
    <script>
        /**
         * æœ€ä½³æµå¼éŸ³é¢‘æ’­æ”¾å™¨
         * æ–¹æ¡ˆï¼šç´¯ç§¯æ‰€æœ‰æ•°æ®ï¼Œå®šæœŸæ›´æ–°ï¼Œæ’­æ”¾å®Œè‡ªåŠ¨ç»­æ’­
         * ä¼˜ç‚¹ï¼šç®€å•ç¨³å®šï¼Œå®Œæ•´æ§ä»¶ï¼Œå…¼å®¹æ‰€æœ‰æµè§ˆå™¨
         */
        class SmartStreamingPlayer {
            constructor(container, options = {}) {
                this.container = container;
                this.options = {
                    format: 'mp3',
                    ...options
                };
                
                this.chunks = [];
                this.totalSize = 0;
                this.audioElement = null;
                this.currentUrl = null;
                this.isFinished = false;
                this.lastPlayedTime = 0;
                
                this.init();
            }
            
            init() {
                this.container.innerHTML = `
                    <div class="streaming-player">
                        <div class="player-status mb-2">
                            <small class="text-info">
                                <i class="bi bi-broadcast"></i> 
                                <span class="status-text">å‡†å¤‡ä¸­...</span>
                            </small>
                        </div>
                        <audio controls style="width: 100%;"></audio>
                    </div>
                `;
                
                this.audioElement = this.container.querySelector('audio');
                this.statusText = this.container.querySelector('.status-text');
                
                // æ ¸å¿ƒï¼šæ’­æ”¾ç»“æŸæ—¶æ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…å®¹
                this.audioElement.addEventListener('ended', () => {
                    if (!this.isFinished) {
                        // è¿˜æ²¡ç”Ÿæˆå®Œï¼Œæ›´æ–°å¹¶ç»§ç»­æ’­æ”¾
                        this.refreshAudio();
                    }
                });
                
                // æ’­æ”¾å¿«ç»“æŸæ—¶é¢„æ›´æ–°
                this.audioElement.addEventListener('timeupdate', () => {
                    if (this.isFinished) return;
                    
                    const remaining = (this.audioElement.duration || 0) - (this.audioElement.currentTime || 0);
                    if (remaining < 0.5 && remaining > 0) {
                        this.refreshAudio();
                    }
                });
            }
            
            addAudioData(audioData) {
                const uint8Array = new Uint8Array(audioData);
                this.chunks.push(uint8Array);
                this.totalSize += uint8Array.length;
                
                // é¦–æ¬¡æœ‰æ•°æ®æ—¶ç«‹å³åˆ›å»ºéŸ³é¢‘
                if (this.chunks.length === 1) {
                    this.refreshAudio();
                }
            }
            
            refreshAudio() {
                if (this.chunks.length === 0) return;
                
                const currentTime = this.audioElement.currentTime || 0;
                const wasPlaying = !this.audioElement.paused;
                const rate = this.audioElement.playbackRate || 1;
                
                // æ¸…ç†æ—§ URL
                if (this.currentUrl) {
                    URL.revokeObjectURL(this.currentUrl);
                }
                
                // åˆ›å»ºæ–°éŸ³é¢‘
                const format = this.options.format || 'mp3';
                const mimeType = format === 'mp3' ? 'audio/mpeg' : `audio/${format}`;
                const blob = new Blob(this.chunks, { type: mimeType });
                this.currentUrl = URL.createObjectURL(blob);
                
                this.audioElement.src = this.currentUrl;
                this.audioElement.playbackRate = rate;
                
                // æ¢å¤æ’­æ”¾ä½ç½®
                this.audioElement.addEventListener('loadedmetadata', () => {
                    if (currentTime > 0 && currentTime < this.audioElement.duration) {
                        this.audioElement.currentTime = currentTime;
                    }
                    if (wasPlaying) {
                        this.audioElement.play().catch(() => {});
                    }
                }, { once: true });
                
                console.log(`[Player] Refreshed: ${(blob.size/1024).toFixed(1)}KB`);
            }
            
            play() {
                return this.audioElement ? this.audioElement.play() : Promise.reject();
            }
            
            pause() {
                if (this.audioElement) this.audioElement.pause();
            }
            
            updateStatus(message) {
                if (this.statusText) this.statusText.textContent = message;
            }
            
            finalize() {
                this.isFinished = true;
                this.refreshAudio(); // æœ€ç»ˆåˆ·æ–°ç¡®ä¿å®Œæ•´
                this.updateStatus('ç”Ÿæˆå®Œæˆ');
            }
            
            getAudioElement() {
                return this.audioElement;
            }
            
            destroy() {
                if (this.currentUrl) URL.revokeObjectURL(this.currentUrl);
                this.chunks = [];
            }
        }
        
        // å…¨å±€å˜é‡
        let currentAudioUrl = null;
        let currentAudioBlob = null;
        let history = [];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateCharCount();
            document.getElementById('input_text').addEventListener('input', updateCharCount);
            document.getElementById('speed').addEventListener('input', updateSpeedValue);
            
            // è®¾ç½®æ–‡ä»¶ä¸Šä¼ 
            setupFileUpload();
            
            // åŠ è½½å†å²è®°å½•
            loadHistory();
            
            // ç›‘å¬é€‰é¡¹å˜åŒ–ï¼Œæ›´æ–°curlç¤ºä¾‹
            document.getElementById('model').addEventListener('change', updateCurlExample);
            document.getElementById('voice').addEventListener('change', updateCurlExample);
            document.getElementById('custom_voice').addEventListener('input', updateCurlExample);
            document.getElementById('speed').addEventListener('input', updateCurlExample);
            
            // ç›‘å¬æ ¼å¼å˜åŒ–
            document.querySelectorAll('input[name="response_format"]').forEach(radio => {
                radio.addEventListener('change', updateCurlExample);
            });
            
            // åˆå§‹æ›´æ–°
            updateCurlExample();
        });
        
        // æ›´æ–°curlç¤ºä¾‹
        function updateCurlExample() {
            const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            const model = document.getElementById('model').value;
            const customVoice = document.getElementById('custom_voice').value.trim();
            const voice = customVoice || document.getElementById('voice').value;
            const format = document.querySelector('input[name="response_format"]:checked').value;
            const speed = document.getElementById('speed').value;
            
            // æ›´æ–°API URL
            document.getElementById('curlBaseUrl').textContent = apiBaseUrl;
            document.getElementById('apiEndpointDisplay').textContent = apiBaseUrl;
            
            // æ›´æ–°å…¶ä»–å‚æ•°
            document.getElementById('curlModel').textContent = model;
            document.getElementById('curlVoice').textContent = voice;
            document.getElementById('curlFormat').textContent = format;
            document.getElementById('curlSpeed').textContent = speed;
            document.getElementById('curlExt').textContent = format;
        }
        
        // è®°å½•åˆ°æœåŠ¡å™¨æ•°æ®åº“
        function logToServer(data) {
            fetch('/api/log_generation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).catch(e => console.log('Log to server failed:', e));
        }
        
        // å¤åˆ¶curlå‘½ä»¤
        function copyCurlExample() {
            const code = document.getElementById('curlExample');
            const text = code.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check"></i> å·²å¤åˆ¶';
                btn.classList.remove('btn-outline-light');
                btn.classList.add('btn-success');
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-light');
                }, 2000);
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥: ' + err);
            });
        }
        
        // å½“å‰è¾“å…¥æ¨¡å¼å’Œä¸Šä¼ çš„æ–‡ä»¶å†…å®¹
        let currentInputMode = 'text';
        let uploadedFileContent = '';
        let uploadedFileName = '';
        let urlLoadedText = ''; // URLåŠ è½½çš„æ–‡æœ¬
        
        // æ›´æ–°å­—ç¬¦è®¡æ•°
        function updateCharCount() {
            const text = getCurrentText();
            document.getElementById('charCount').textContent = text.length;
            
            // æ›´æ–°è¡Œæ•°
            const lines = text.split('\n').length;
            document.getElementById('lineCount').textContent = lines;
            document.getElementById('wordCountBadge').style.display = text.length > 0 ? 'inline' : 'none';
        }
        
        // è·å–å½“å‰æ–‡æœ¬ï¼ˆæ ¹æ®è¾“å…¥æ¨¡å¼ï¼‰
        function getCurrentText() {
            if (currentInputMode === 'file' && uploadedFileContent) {
                return uploadedFileContent;
            }
            if (currentInputMode === 'url' && urlLoadedText) {
                return urlLoadedText;
            }
            return document.getElementById('input_text').value;
        }
        
        // åˆ‡æ¢è¾“å…¥æ¨¡å¼
        function switchInputMode(mode) {
            currentInputMode = mode;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.getElementById('tabText').classList.toggle('active', mode === 'text');
            document.getElementById('tabFile').classList.toggle('active', mode === 'file');
            document.getElementById('tabUrl').classList.toggle('active', mode === 'url');
            
            // åˆ‡æ¢æ˜¾ç¤ºåŒºåŸŸ
            document.getElementById('textInputMode').style.display = mode === 'text' ? 'block' : 'none';
            document.getElementById('fileInputMode').style.display = mode === 'file' ? 'block' : 'none';
            document.getElementById('urlInputMode').style.display = mode === 'url' ? 'block' : 'none';
            
            // æ›´æ–°å­—ç¬¦è®¡æ•°
            updateCharCount();
        }
        
        // ä»URLåŠ è½½æ–‡æœ¬
        async function loadFromUrl() {
            const urlInput = document.getElementById('textUrl');
            const url = urlInput.value.trim();
            const statusEl = document.getElementById('urlLoadStatus');
            const loadBtn = document.getElementById('loadUrlBtn');
            
            if (!url) {
                showUrlStatus('è¯·è¾“å…¥URL', 'warning');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½ä¸­
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> åŠ è½½ä¸­...';
            showUrlStatus('<i class="bi bi-hourglass-split"></i> æ­£åœ¨åŠ è½½...', 'info');
            
            try {
                const response = await fetch('/api/fetch_url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    urlLoadedText = data.text;
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    const previewEl = document.getElementById('urlPreview');
                    const contentEl = document.getElementById('urlPreviewContent');
                    const charCountEl = document.getElementById('urlCharCount');
                    
                    previewEl.style.display = 'block';
                    contentEl.textContent = data.text;
                    charCountEl.textContent = `${data.length} å­—ç¬¦`;
                    
                    showUrlStatus(`<i class="bi bi-check-circle"></i> åŠ è½½æˆåŠŸï¼${data.length} å­—ç¬¦`, 'success');
                    updateCharCount();
                } else {
                    showUrlStatus(`<i class="bi bi-exclamation-circle"></i> ${data.error}`, 'danger');
                }
            } catch (e) {
                showUrlStatus(`<i class="bi bi-exclamation-circle"></i> åŠ è½½å¤±è´¥: ${e.message}`, 'danger');
            } finally {
                loadBtn.disabled = false;
                loadBtn.innerHTML = '<i class="bi bi-download"></i> åŠ è½½';
            }
        }
        
        function showUrlStatus(message, type) {
            const statusEl = document.getElementById('urlLoadStatus');
            statusEl.style.display = 'block';
            statusEl.className = `alert alert-${type} py-2`;
            statusEl.innerHTML = message;
        }
        
        function clearUrlContent() {
            urlLoadedText = '';
            document.getElementById('urlPreview').style.display = 'none';
            document.getElementById('urlPreviewContent').textContent = '';
            document.getElementById('urlLoadStatus').style.display = 'none';
            document.getElementById('textUrl').value = '';
            updateCharCount();
        }
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function setupFileUpload() {
            const fileInput = document.getElementById('fileUpload');
            const uploadZone = document.getElementById('uploadZone');
            
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
            
            // æ‹–æ‹½äº‹ä»¶
            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadZone.classList.add('drag-over');
            });
            
            uploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadZone.classList.remove('drag-over');
            });
            
            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadZone.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
        }
        
        // å¤„ç†æ–‡ä»¶
        function handleFile(file) {
            const allowedTypes = ['.txt', '.md', '.text', '.srt', '.vtt', '.json'];
            const fileName = file.name.toLowerCase();
            const isAllowed = allowedTypes.some(ext => fileName.endsWith(ext));
            
            if (!isAllowed) {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼è¯·ä¸Šä¼  .txt, .md, .srt, .vtt æ ¼å¼çš„æ–‡ä»¶ã€‚');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                let content = e.target.result;
                
                // å¤„ç† SRT/VTT å­—å¹•æ–‡ä»¶ï¼Œæå–çº¯æ–‡æœ¬
                if (fileName.endsWith('.srt') || fileName.endsWith('.vtt')) {
                    content = parseSubtitle(content);
                }
                
                uploadedFileContent = content;
                uploadedFileName = file.name;
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                document.getElementById('uploadZone').style.display = 'none';
                document.getElementById('uploadedFileInfo').style.display = 'block';
                document.getElementById('uploadedFileName').textContent = file.name;
                document.getElementById('uploadedFileSize').textContent = formatFileSize(file.size) + ' Â· ' + content.length + ' å­—ç¬¦';
                
                // æ˜¾ç¤ºé¢„è§ˆ
                document.getElementById('filePreview').style.display = 'block';
                document.getElementById('filePreviewContent').textContent = content.substring(0, 1000) + (content.length > 1000 ? '\n...(æ›´å¤šå†…å®¹å·²çœç•¥)' : '');
                
                // æ›´æ–°å­—ç¬¦è®¡æ•°
                updateCharCount();
            };
            reader.readAsText(file);
        }
        
        // è§£æå­—å¹•æ–‡ä»¶
        function parseSubtitle(content) {
            // ç§»é™¤æ—¶é—´æˆ³å’Œåºå·ï¼Œåªä¿ç•™æ–‡æœ¬
            const lines = content.split('\n');
            const textLines = [];
            
            for (let line of lines) {
                line = line.trim();
                // è·³è¿‡ç©ºè¡Œã€åºå·ã€æ—¶é—´æˆ³ã€WEBVTT å¤´
                if (!line) continue;
                if (/^\d+$/.test(line)) continue;
                if (/^\d{2}:\d{2}/.test(line)) continue;
                if (line.startsWith('WEBVTT')) continue;
                if (line.includes('-->')) continue;
                
                textLines.push(line);
            }
            
            return textLines.join('\n');
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        // ç§»é™¤ä¸Šä¼ çš„æ–‡ä»¶
        function removeUploadedFile() {
            uploadedFileContent = '';
            uploadedFileName = '';
            
            document.getElementById('fileUpload').value = '';
            document.getElementById('uploadZone').style.display = 'block';
            document.getElementById('uploadedFileInfo').style.display = 'none';
            document.getElementById('filePreview').style.display = 'none';
            
            updateCharCount();
        }
        
        // åˆ‡æ¢é¢„è§ˆå±•å¼€/æ”¶èµ·
        function toggleFullPreview() {
            const content = document.getElementById('filePreviewContent');
            const toggleText = document.getElementById('previewToggleText');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggleText.textContent = 'å±•å¼€å…¨éƒ¨';
                content.textContent = uploadedFileContent.substring(0, 1000) + (uploadedFileContent.length > 1000 ? '\n...(æ›´å¤šå†…å®¹å·²çœç•¥)' : '');
            } else {
                content.classList.add('expanded');
                toggleText.textContent = 'æ”¶èµ·';
                content.textContent = uploadedFileContent;
            }
        }
        
        // ä»å‰ªè´´æ¿ç²˜è´´
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                if (currentInputMode === 'text') {
                    document.getElementById('input_text').value = text;
                } else {
                    // åœ¨æ–‡ä»¶æ¨¡å¼ä¸‹ï¼Œåˆ‡æ¢åˆ°æ–‡æœ¬æ¨¡å¼å¹¶ç²˜è´´
                    switchInputMode('text');
                    document.getElementById('input_text').value = text;
                }
                updateCharCount();
            } catch (err) {
                alert('æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´ã€‚');
            }
        }
        
        // æ›´æ–°é€Ÿåº¦æ˜¾ç¤º
        function updateSpeedValue() {
            const speed = document.getElementById('speed').value;
            document.getElementById('speedValue').textContent = speed + 'x';
        }
        
        // åˆ‡æ¢ API Key å¯è§æ€§
        function toggleApiKeyVisibility() {
            const input = document.getElementById('api_key');
            const icon = document.getElementById('apiKeyToggleIcon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'bi bi-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'bi bi-eye';
            }
        }
        
        // æ¸…ç©ºæ–‡æœ¬
        function clearText() {
            if (currentInputMode === 'text') {
                document.getElementById('input_text').value = '';
            } else {
                removeUploadedFile();
            }
            updateCharCount();
        }
        
        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = 'status-message loading';
            statusEl.innerHTML = '<div class="loading-spinner"></div> æ­£åœ¨æµ‹è¯•è¿æ¥...';
            statusEl.style.display = 'flex';
            
            try {
                const response = await fetch('/api/test_connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: document.getElementById('api_key').value })
                });
                const data = await response.json();
                
                if (data.success) {
                    statusEl.className = 'status-message success';
                    statusEl.innerHTML = '<i class="bi bi-check-circle"></i> è¿æ¥æˆåŠŸï¼';
                } else {
                    statusEl.className = 'status-message error';
                    statusEl.innerHTML = '<i class="bi bi-x-circle"></i> ' + data.message;
                }
            } catch (error) {
                statusEl.className = 'status-message error';
                statusEl.innerHTML = '<i class="bi bi-x-circle"></i> è¿æ¥å¤±è´¥: ' + error.message;
            }
        }
        
        // åŠ è½½æ¨¡å‹
        async function loadModels() {
            try {
                const apiKey = document.getElementById('api_key').value;
                const response = await fetch('/api/models', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: apiKey })
                });
                const data = await response.json();
                
                if (data.error) {
                    alert('åŠ è½½æ¨¡å‹å¤±è´¥: ' + data.error);
                    return;
                }
                
                // API è¿”å› {"models": [{"id": "tts-1"}, ...]}
                const models = data.models || data;
                
                const select = document.getElementById('model');
                const currentValue = select.value;
                select.innerHTML = '';
                
                models.forEach(model => {
                    const option = document.createElement('option');
                    const modelId = model.id || model;
                    option.value = modelId;
                    option.textContent = modelId;
                    select.appendChild(option);
                });
                
                if (models.some(m => (m.id || m) === currentValue)) {
                    select.value = currentValue;
                }
                
                alert('å·²åŠ è½½ ' + models.length + ' ä¸ªæ¨¡å‹');
            } catch (error) {
                alert('åŠ è½½æ¨¡å‹å¤±è´¥: ' + error.message);
            }
        }
        
        // å®Œæ•´çš„ Edge-TTS è¯­éŸ³åˆ—è¡¨
        const ALL_EDGE_TTS_VOICES = {
            "OpenAI Compatible": [
                {name: "alloy", gender: "Neutral"},
                {name: "echo", gender: "Male"},
                {name: "fable", gender: "Female"},
                {name: "onyx", gender: "Male"},
                {name: "nova", gender: "Female"},
                {name: "shimmer", gender: "Female"}
            ],
            "zh-CN (ä¸­æ–‡-æ™®é€šè¯)": [
                {name: "zh-CN-XiaoxiaoNeural", gender: "Female"},
                {name: "zh-CN-YunxiNeural", gender: "Male"},
                {name: "zh-CN-YunjianNeural", gender: "Male"},
                {name: "zh-CN-XiaoyiNeural", gender: "Female"},
                {name: "zh-CN-YunyangNeural", gender: "Male"},
                {name: "zh-CN-XiaohanNeural", gender: "Female"},
                {name: "zh-CN-XiaomoNeural", gender: "Female"},
                {name: "zh-CN-XiaochenNeural", gender: "Female"},
                {name: "zh-CN-XiaoruiNeural", gender: "Female"},
                {name: "zh-CN-XiaoshuangNeural", gender: "Female"},
                {name: "zh-CN-XiaoxuanNeural", gender: "Female"},
                {name: "zh-CN-XiaoyanNeural", gender: "Female"},
                {name: "zh-CN-XiaoyouNeural", gender: "Female"},
                {name: "zh-CN-XiaozhenNeural", gender: "Female"},
                {name: "zh-CN-XiaomengNeural", gender: "Female"},
                {name: "zh-CN-YunfengNeural", gender: "Male"},
                {name: "zh-CN-YunhaoNeural", gender: "Male"},
                {name: "zh-CN-YunxiaNeural", gender: "Male"},
                {name: "zh-CN-YunyeNeural", gender: "Male"},
                {name: "zh-CN-YunzeNeural", gender: "Male"},
                {name: "zh-CN-liaoning-XiaobeiNeural", gender: "Female"},
                {name: "zh-CN-shaanxi-XiaoniNeural", gender: "Female"}
            ],
            "zh-TW (ä¸­æ–‡-å°æ¹¾)": [
                {name: "zh-TW-HsiaoChenNeural", gender: "Female"},
                {name: "zh-TW-HsiaoYuNeural", gender: "Female"},
                {name: "zh-TW-YunJheNeural", gender: "Male"}
            ],
            "zh-HK (ä¸­æ–‡-ç²¤è¯­)": [
                {name: "zh-HK-HiuGaaiNeural", gender: "Female"},
                {name: "zh-HK-HiuMaanNeural", gender: "Female"},
                {name: "zh-HK-WanLungNeural", gender: "Male"}
            ],
            "en-US (English-US)": [
                {name: "en-US-AvaNeural", gender: "Female"},
                {name: "en-US-AndrewNeural", gender: "Male"},
                {name: "en-US-EmmaNeural", gender: "Female"},
                {name: "en-US-BrianNeural", gender: "Male"},
                {name: "en-US-JennyNeural", gender: "Female"},
                {name: "en-US-GuyNeural", gender: "Male"},
                {name: "en-US-AriaNeural", gender: "Female"},
                {name: "en-US-DavisNeural", gender: "Male"},
                {name: "en-US-JaneNeural", gender: "Female"},
                {name: "en-US-JasonNeural", gender: "Male"},
                {name: "en-US-SaraNeural", gender: "Female"},
                {name: "en-US-TonyNeural", gender: "Male"},
                {name: "en-US-NancyNeural", gender: "Female"},
                {name: "en-US-AmberNeural", gender: "Female"},
                {name: "en-US-AnaNeural", gender: "Female"},
                {name: "en-US-AshleyNeural", gender: "Female"},
                {name: "en-US-BrandonNeural", gender: "Male"},
                {name: "en-US-ChristopherNeural", gender: "Male"},
                {name: "en-US-CoraNeural", gender: "Female"},
                {name: "en-US-ElizabethNeural", gender: "Female"},
                {name: "en-US-EricNeural", gender: "Male"},
                {name: "en-US-JacobNeural", gender: "Male"},
                {name: "en-US-MichelleNeural", gender: "Female"},
                {name: "en-US-MonicaNeural", gender: "Female"},
                {name: "en-US-RogerNeural", gender: "Male"},
                {name: "en-US-SteffanNeural", gender: "Male"}
            ],
            "en-GB (English-UK)": [
                {name: "en-GB-SoniaNeural", gender: "Female"},
                {name: "en-GB-RyanNeural", gender: "Male"},
                {name: "en-GB-LibbyNeural", gender: "Female"},
                {name: "en-GB-AbbiNeural", gender: "Female"},
                {name: "en-GB-AlfieNeural", gender: "Male"},
                {name: "en-GB-BellaNeural", gender: "Female"},
                {name: "en-GB-ElliotNeural", gender: "Male"},
                {name: "en-GB-EthanNeural", gender: "Male"},
                {name: "en-GB-HollieNeural", gender: "Female"},
                {name: "en-GB-MaisieNeural", gender: "Female"},
                {name: "en-GB-NoahNeural", gender: "Male"},
                {name: "en-GB-OliverNeural", gender: "Male"},
                {name: "en-GB-OliviaNeural", gender: "Female"},
                {name: "en-GB-ThomasNeural", gender: "Male"}
            ],
            "ja-JP (æ—¥æœ¬èª)": [
                {name: "ja-JP-NanamiNeural", gender: "Female"},
                {name: "ja-JP-KeitaNeural", gender: "Male"},
                {name: "ja-JP-AoiNeural", gender: "Female"},
                {name: "ja-JP-DaichiNeural", gender: "Male"},
                {name: "ja-JP-MayuNeural", gender: "Female"},
                {name: "ja-JP-NaokiNeural", gender: "Male"},
                {name: "ja-JP-ShioriNeural", gender: "Female"}
            ],
            "ko-KR (í•œêµ­ì–´)": [
                {name: "ko-KR-SunHiNeural", gender: "Female"},
                {name: "ko-KR-InJoonNeural", gender: "Male"},
                {name: "ko-KR-BongJinNeural", gender: "Male"},
                {name: "ko-KR-GookMinNeural", gender: "Male"},
                {name: "ko-KR-JiMinNeural", gender: "Female"},
                {name: "ko-KR-SeoHyeonNeural", gender: "Female"},
                {name: "ko-KR-SoonBokNeural", gender: "Female"},
                {name: "ko-KR-YuJinNeural", gender: "Female"}
            ],
            "de-DE (Deutsch)": [
                {name: "de-DE-KatjaNeural", gender: "Female"},
                {name: "de-DE-ConradNeural", gender: "Male"},
                {name: "de-DE-AmalaNeural", gender: "Female"},
                {name: "de-DE-BerndNeural", gender: "Male"},
                {name: "de-DE-ChristophNeural", gender: "Male"},
                {name: "de-DE-ElkeNeural", gender: "Female"},
                {name: "de-DE-GiselaNeural", gender: "Female"},
                {name: "de-DE-KasperNeural", gender: "Male"},
                {name: "de-DE-KillianNeural", gender: "Male"},
                {name: "de-DE-KlarissaNeural", gender: "Female"},
                {name: "de-DE-KlausNeural", gender: "Male"},
                {name: "de-DE-LouisaNeural", gender: "Female"},
                {name: "de-DE-MajaNeural", gender: "Female"},
                {name: "de-DE-RalfNeural", gender: "Male"},
                {name: "de-DE-TanjaNeural", gender: "Female"}
            ],
            "fr-FR (FranÃ§ais)": [
                {name: "fr-FR-DeniseNeural", gender: "Female"},
                {name: "fr-FR-HenriNeural", gender: "Male"},
                {name: "fr-FR-AlainNeural", gender: "Male"},
                {name: "fr-FR-BrigitteNeural", gender: "Female"},
                {name: "fr-FR-CelesteNeural", gender: "Female"},
                {name: "fr-FR-ClaudeNeural", gender: "Male"},
                {name: "fr-FR-CoralieNeural", gender: "Female"},
                {name: "fr-FR-EloiseNeural", gender: "Female"},
                {name: "fr-FR-JacquelineNeural", gender: "Female"},
                {name: "fr-FR-JeromeNeural", gender: "Male"},
                {name: "fr-FR-JosephineNeural", gender: "Female"},
                {name: "fr-FR-MauriceNeural", gender: "Male"},
                {name: "fr-FR-YvesNeural", gender: "Male"},
                {name: "fr-FR-YvetteNeural", gender: "Female"}
            ],
            "es-ES (EspaÃ±ol)": [
                {name: "es-ES-ElviraNeural", gender: "Female"},
                {name: "es-ES-AlvaroNeural", gender: "Male"},
                {name: "es-ES-AbrilNeural", gender: "Female"},
                {name: "es-ES-ArnauNeural", gender: "Male"},
                {name: "es-ES-DarioNeural", gender: "Male"},
                {name: "es-ES-EliasNeural", gender: "Male"},
                {name: "es-ES-EstrellaNeural", gender: "Female"},
                {name: "es-ES-IreneNeural", gender: "Female"},
                {name: "es-ES-LaiaNeural", gender: "Female"},
                {name: "es-ES-LiaNeural", gender: "Female"},
                {name: "es-ES-NilNeural", gender: "Male"},
                {name: "es-ES-SaulNeural", gender: "Male"},
                {name: "es-ES-TeoNeural", gender: "Male"},
                {name: "es-ES-TrianaNeural", gender: "Female"},
                {name: "es-ES-VeraNeural", gender: "Female"}
            ],
            "es-MX (EspaÃ±ol-MÃ©xico)": [
                {name: "es-MX-DaliaNeural", gender: "Female"},
                {name: "es-MX-JorgeNeural", gender: "Male"},
                {name: "es-MX-BeatrizNeural", gender: "Female"},
                {name: "es-MX-CandelaNeural", gender: "Female"},
                {name: "es-MX-CarlotaNeural", gender: "Female"},
                {name: "es-MX-CecilioNeural", gender: "Male"},
                {name: "es-MX-GerardoNeural", gender: "Male"},
                {name: "es-MX-LarissaNeural", gender: "Female"},
                {name: "es-MX-LibertoNeural", gender: "Male"},
                {name: "es-MX-LucianoNeural", gender: "Male"},
                {name: "es-MX-MarinaNeural", gender: "Female"},
                {name: "es-MX-NuriaNeural", gender: "Female"},
                {name: "es-MX-PelayoNeural", gender: "Male"},
                {name: "es-MX-RenataNeural", gender: "Female"},
                {name: "es-MX-YagoNeural", gender: "Male"}
            ],
            "it-IT (Italiano)": [
                {name: "it-IT-IsabellaNeural", gender: "Female"},
                {name: "it-IT-DiegoNeural", gender: "Male"},
                {name: "it-IT-ElsaNeural", gender: "Female"},
                {name: "it-IT-BenignoNeural", gender: "Male"},
                {name: "it-IT-CalimeroNeural", gender: "Male"},
                {name: "it-IT-CataldoNeural", gender: "Male"},
                {name: "it-IT-FabiolaNeural", gender: "Female"},
                {name: "it-IT-FiammaNeural", gender: "Female"},
                {name: "it-IT-GianniNeural", gender: "Male"},
                {name: "it-IT-ImeldaNeural", gender: "Female"},
                {name: "it-IT-IrmaNeural", gender: "Female"},
                {name: "it-IT-LisandroNeural", gender: "Male"},
                {name: "it-IT-PalmiraNeural", gender: "Female"},
                {name: "it-IT-PierinaNeural", gender: "Female"},
                {name: "it-IT-RinaldoNeural", gender: "Male"}
            ],
            "pt-BR (PortuguÃªs-Brasil)": [
                {name: "pt-BR-FranciscaNeural", gender: "Female"},
                {name: "pt-BR-AntonioNeural", gender: "Male"},
                {name: "pt-BR-BrendaNeural", gender: "Female"},
                {name: "pt-BR-DonatoNeural", gender: "Male"},
                {name: "pt-BR-ElzaNeural", gender: "Female"},
                {name: "pt-BR-FabioNeural", gender: "Male"},
                {name: "pt-BR-GiovannaNeural", gender: "Female"},
                {name: "pt-BR-HumbertoNeural", gender: "Male"},
                {name: "pt-BR-JulioNeural", gender: "Male"},
                {name: "pt-BR-LeilaNeural", gender: "Female"},
                {name: "pt-BR-LeticiaNeural", gender: "Female"},
                {name: "pt-BR-ManuelaNeural", gender: "Female"},
                {name: "pt-BR-NicolauNeural", gender: "Male"},
                {name: "pt-BR-ValerioNeural", gender: "Male"},
                {name: "pt-BR-YaraNeural", gender: "Female"}
            ],
            "ru-RU (Ğ ÑƒÑÑĞºĞ¸Ğ¹)": [
                {name: "ru-RU-SvetlanaNeural", gender: "Female"},
                {name: "ru-RU-DmitryNeural", gender: "Male"},
                {name: "ru-RU-DariyaNeural", gender: "Female"}
            ],
            "ar-SA (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)": [
                {name: "ar-SA-ZariyahNeural", gender: "Female"},
                {name: "ar-SA-HamedNeural", gender: "Male"}
            ],
            "ar-EG (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©-Ù…ØµØ±)": [
                {name: "ar-EG-SalmaNeural", gender: "Female"},
                {name: "ar-EG-ShakirNeural", gender: "Male"}
            ],
            "hi-IN (à¤¹à¤¿à¤¨à¥à¤¦à¥€)": [
                {name: "hi-IN-SwaraNeural", gender: "Female"},
                {name: "hi-IN-MadhurNeural", gender: "Male"}
            ],
            "th-TH (à¹„à¸—à¸¢)": [
                {name: "th-TH-PremwadeeNeural", gender: "Female"},
                {name: "th-TH-NiwatNeural", gender: "Male"}
            ],
            "vi-VN (Tiáº¿ng Viá»‡t)": [
                {name: "vi-VN-HoaiMyNeural", gender: "Female"},
                {name: "vi-VN-NamMinhNeural", gender: "Male"}
            ],
            "id-ID (Bahasa Indonesia)": [
                {name: "id-ID-GadisNeural", gender: "Female"},
                {name: "id-ID-ArdiNeural", gender: "Male"}
            ],
            "ms-MY (Bahasa Melayu)": [
                {name: "ms-MY-YasminNeural", gender: "Female"},
                {name: "ms-MY-OsmanNeural", gender: "Male"}
            ],
            "nl-NL (Nederlands)": [
                {name: "nl-NL-FennaNeural", gender: "Female"},
                {name: "nl-NL-MaartenNeural", gender: "Male"},
                {name: "nl-NL-ColetteNeural", gender: "Female"}
            ],
            "pl-PL (Polski)": [
                {name: "pl-PL-AgnieszkaNeural", gender: "Female"},
                {name: "pl-PL-MarekNeural", gender: "Male"},
                {name: "pl-PL-ZofiaNeural", gender: "Female"}
            ],
            "tr-TR (TÃ¼rkÃ§e)": [
                {name: "tr-TR-EmelNeural", gender: "Female"},
                {name: "tr-TR-AhmetNeural", gender: "Male"}
            ],
            "sv-SE (Svenska)": [
                {name: "sv-SE-SofieNeural", gender: "Female"},
                {name: "sv-SE-MattiasNeural", gender: "Male"},
                {name: "sv-SE-HilleviNeural", gender: "Female"}
            ],
            "da-DK (Dansk)": [
                {name: "da-DK-ChristelNeural", gender: "Female"},
                {name: "da-DK-JeppeNeural", gender: "Male"}
            ],
            "fi-FI (Suomi)": [
                {name: "fi-FI-SelmaNeural", gender: "Female"},
                {name: "fi-FI-HarriNeural", gender: "Male"},
                {name: "fi-FI-NooraNeural", gender: "Female"}
            ],
            "no-NO (Norsk)": [
                {name: "no-NO-PernilleNeural", gender: "Female"},
                {name: "no-NO-FinnNeural", gender: "Male"},
                {name: "no-NO-IselinNeural", gender: "Female"}
            ],
            "cs-CZ (ÄŒeÅ¡tina)": [
                {name: "cs-CZ-VlastaNeural", gender: "Female"},
                {name: "cs-CZ-AntoninNeural", gender: "Male"}
            ],
            "el-GR (Î•Î»Î»Î·Î½Î¹ÎºÎ¬)": [
                {name: "el-GR-AthinaNeural", gender: "Female"},
                {name: "el-GR-NestorasNeural", gender: "Male"}
            ],
            "he-IL (×¢×‘×¨×™×ª)": [
                {name: "he-IL-HilaNeural", gender: "Female"},
                {name: "he-IL-AvriNeural", gender: "Male"}
            ],
            "hu-HU (Magyar)": [
                {name: "hu-HU-NoemiNeural", gender: "Female"},
                {name: "hu-HU-TamasNeural", gender: "Male"}
            ],
            "ro-RO (RomÃ¢nÄƒ)": [
                {name: "ro-RO-AlinaNeural", gender: "Female"},
                {name: "ro-RO-EmilNeural", gender: "Male"}
            ],
            "sk-SK (SlovenÄina)": [
                {name: "sk-SK-ViktoriaNeural", gender: "Female"},
                {name: "sk-SK-LukasNeural", gender: "Male"}
            ],
            "uk-UA (Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°)": [
                {name: "uk-UA-PolinaNeural", gender: "Female"},
                {name: "uk-UA-OstapNeural", gender: "Male"}
            ],
            "bg-BG (Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸)": [
                {name: "bg-BG-KalinaNeural", gender: "Female"},
                {name: "bg-BG-BorislavNeural", gender: "Male"}
            ],
            "hr-HR (Hrvatski)": [
                {name: "hr-HR-GabrijelaNeural", gender: "Female"},
                {name: "hr-HR-SreckoNeural", gender: "Male"}
            ],
            "sl-SI (SlovenÅ¡Äina)": [
                {name: "sl-SI-PetraNeural", gender: "Female"},
                {name: "sl-SI-RokNeural", gender: "Male"}
            ],
            "ca-ES (CatalÃ )": [
                {name: "ca-ES-JoanaNeural", gender: "Female"},
                {name: "ca-ES-EnricNeural", gender: "Male"},
                {name: "ca-ES-AlbaNeural", gender: "Female"}
            ],
            "af-ZA (Afrikaans)": [
                {name: "af-ZA-AdriNeural", gender: "Female"},
                {name: "af-ZA-WillemNeural", gender: "Male"}
            ],
            "bn-IN (à¦¬à¦¾à¦‚à¦²à¦¾)": [
                {name: "bn-IN-TanishaaNeural", gender: "Female"},
                {name: "bn-IN-BashkarNeural", gender: "Male"}
            ],
            "ta-IN (à®¤à®®à®¿à®´à¯)": [
                {name: "ta-IN-PallaviNeural", gender: "Female"},
                {name: "ta-IN-ValluvarNeural", gender: "Male"}
            ],
            "te-IN (à°¤à±†à°²à±à°—à±)": [
                {name: "te-IN-ShrutiNeural", gender: "Female"},
                {name: "te-IN-MohanNeural", gender: "Male"}
            ],
            "mr-IN (à¤®à¤°à¤¾à¤ à¥€)": [
                {name: "mr-IN-AarohiNeural", gender: "Female"},
                {name: "mr-IN-ManoharNeural", gender: "Male"}
            ],
            "gu-IN (àª—à«àªœàª°àª¾àª¤à«€)": [
                {name: "gu-IN-DhwaniNeural", gender: "Female"},
                {name: "gu-IN-NiranjanNeural", gender: "Male"}
            ],
            "kn-IN (à²•à²¨à³à²¨à²¡)": [
                {name: "kn-IN-SapnaNeural", gender: "Female"},
                {name: "kn-IN-GaganNeural", gender: "Male"}
            ],
            "ml-IN (à´®à´²à´¯à´¾à´³à´‚)": [
                {name: "ml-IN-SobhanaNeural", gender: "Female"},
                {name: "ml-IN-MidhunNeural", gender: "Male"}
            ],
            "fil-PH (Filipino)": [
                {name: "fil-PH-BlessicaNeural", gender: "Female"},
                {name: "fil-PH-AngeloNeural", gender: "Male"}
            ],
            "en-AU (English-Australia)": [
                {name: "en-AU-NatashaNeural", gender: "Female"},
                {name: "en-AU-WilliamNeural", gender: "Male"},
                {name: "en-AU-AnnetteNeural", gender: "Female"},
                {name: "en-AU-CarlyNeural", gender: "Female"},
                {name: "en-AU-DarrenNeural", gender: "Male"},
                {name: "en-AU-DuncanNeural", gender: "Male"},
                {name: "en-AU-ElsieNeural", gender: "Female"},
                {name: "en-AU-FreyaNeural", gender: "Female"},
                {name: "en-AU-JoanneNeural", gender: "Female"},
                {name: "en-AU-KenNeural", gender: "Male"},
                {name: "en-AU-KimNeural", gender: "Female"},
                {name: "en-AU-NeilNeural", gender: "Male"},
                {name: "en-AU-TimNeural", gender: "Male"},
                {name: "en-AU-TinaNeural", gender: "Female"}
            ],
            "en-CA (English-Canada)": [
                {name: "en-CA-ClaraNeural", gender: "Female"},
                {name: "en-CA-LiamNeural", gender: "Male"}
            ],
            "en-IN (English-India)": [
                {name: "en-IN-NeerjaNeural", gender: "Female"},
                {name: "en-IN-PrabhatNeural", gender: "Male"}
            ],
            "en-IE (English-Ireland)": [
                {name: "en-IE-EmilyNeural", gender: "Female"},
                {name: "en-IE-ConnorNeural", gender: "Male"}
            ],
            "en-NZ (English-New Zealand)": [
                {name: "en-NZ-MollyNeural", gender: "Female"},
                {name: "en-NZ-MitchellNeural", gender: "Male"}
            ],
            "en-SG (English-Singapore)": [
                {name: "en-SG-LunaNeural", gender: "Female"},
                {name: "en-SG-WayneNeural", gender: "Male"}
            ],
            "en-ZA (English-South Africa)": [
                {name: "en-ZA-LeahNeural", gender: "Female"},
                {name: "en-ZA-LukeNeural", gender: "Male"}
            ],
            "en-PH (English-Philippines)": [
                {name: "en-PH-RosaNeural", gender: "Female"},
                {name: "en-PH-JamesNeural", gender: "Male"}
            ],
            "en-HK (English-Hong Kong)": [
                {name: "en-HK-YanNeural", gender: "Female"},
                {name: "en-HK-SamNeural", gender: "Male"}
            ],
            "fr-CA (FranÃ§ais-Canada)": [
                {name: "fr-CA-SylvieNeural", gender: "Female"},
                {name: "fr-CA-JeanNeural", gender: "Male"},
                {name: "fr-CA-AntoineNeural", gender: "Male"}
            ],
            "fr-BE (FranÃ§ais-Belgique)": [
                {name: "fr-BE-CharlineNeural", gender: "Female"},
                {name: "fr-BE-GerardNeural", gender: "Male"}
            ],
            "fr-CH (FranÃ§ais-Suisse)": [
                {name: "fr-CH-ArianeNeural", gender: "Female"},
                {name: "fr-CH-FabriceNeural", gender: "Male"}
            ],
            "de-AT (Deutsch-Ã–sterreich)": [
                {name: "de-AT-IngridNeural", gender: "Female"},
                {name: "de-AT-JonasNeural", gender: "Male"}
            ],
            "de-CH (Deutsch-Schweiz)": [
                {name: "de-CH-LeniNeural", gender: "Female"},
                {name: "de-CH-JanNeural", gender: "Male"}
            ],
            "pt-PT (PortuguÃªs-Portugal)": [
                {name: "pt-PT-RaquelNeural", gender: "Female"},
                {name: "pt-PT-DuarteNeural", gender: "Male"},
                {name: "pt-PT-FernandaNeural", gender: "Female"}
            ]
        };
        
        // åŠ è½½è¯­éŸ³ - ä½¿ç”¨æœ¬åœ°å®Œæ•´åˆ—è¡¨
        async function loadVoices() {
            const select = document.getElementById('voice');
            const currentValue = select.value;
            select.innerHTML = '';
            
            let totalCount = 0;
            
            // éå†æ‰€æœ‰è¯­è¨€ç»„
            Object.keys(ALL_EDGE_TTS_VOICES).forEach(locale => {
                const group = document.createElement('optgroup');
                group.label = locale;
                
                ALL_EDGE_TTS_VOICES[locale].forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = voice.name + ` (${voice.gender})`;
                    group.appendChild(option);
                    totalCount++;
                });
                
                select.appendChild(group);
            });
            
            // æ¢å¤é€‰æ‹©
            const options = Array.from(select.options);
            if (options.some(opt => opt.value === currentValue)) {
                select.value = currentValue;
            }
            
            alert('å·²åŠ è½½ ' + totalCount + ' ä¸ªè¯­éŸ³');
        }
        
        // é¢„è§ˆè¯­éŸ³
        async function previewVoice() {
            const voice = document.getElementById('custom_voice').value || document.getElementById('voice').value;
            const previewPlayer = document.getElementById('voicePreviewPlayer');
            
            previewPlayer.style.display = 'block';
            previewPlayer.innerHTML = '<div class="d-flex align-items-center gap-2"><div class="loading-spinner"></div> æ­£åœ¨ç”Ÿæˆé¢„è§ˆ...</div>';
            
            try {
                const response = await fetch('/api/preview_voice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_key: document.getElementById('api_key').value,
                        voice: voice
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    const audioSrc = 'data:audio/mp3;base64,' + data.audio;
                    previewPlayer.innerHTML = `
                        <p class="mb-2 text-muted" style="font-size: 0.85rem;">"${data.text}"</p>
                        <audio controls autoplay src="${audioSrc}" style="width: 100%;"></audio>
                    `;
                } else {
                    previewPlayer.innerHTML = '<p class="text-danger mb-0"><i class="bi bi-x-circle"></i> ' + data.error + '</p>';
                }
            } catch (error) {
                previewPlayer.innerHTML = '<p class="text-danger mb-0"><i class="bi bi-x-circle"></i> é¢„è§ˆå¤±è´¥: ' + error.message + '</p>';
            }
        }
        
        // ç”Ÿæˆè¯­éŸ³
        async function generateSpeech() {
            const inputText = getCurrentText().trim();
            if (!inputText) {
                alert('è¯·è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬æˆ–ä¸Šä¼ æ–‡ä»¶');
                return;
            }
            
            const btn = document.getElementById('generateBtn');
            const statusEl = document.getElementById('generateStatus');
            const audioOutput = document.getElementById('audioOutput');
            const audioActions = document.getElementById('audioActions');
            
            // ç¦ç”¨æŒ‰é’®
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner d-inline-block me-2"></div> ç”Ÿæˆä¸­...';
            
            const voice = document.getElementById('custom_voice').value || document.getElementById('voice').value;
            const format = document.querySelector('input[name="response_format"]:checked').value;
            const speed = document.getElementById('speed').value;
            const streamMode = document.getElementById('stream_mode').checked;
            const autoDownload = document.getElementById('auto_download').checked;
            
            // æ ¹æ®æ–‡æœ¬é•¿åº¦å’Œç”¨æˆ·é€‰æ‹©å†³å®šæ˜¯å¦ä½¿ç”¨æµå¼
            const textLength = inputText.length;
            const useStream = streamMode;
            
            if (useStream) {
                // æµå¼æ¨¡å¼ - è¾¹ä¸‹è½½è¾¹æ’­æ”¾
                statusEl.className = 'status-message loading';
                statusEl.innerHTML = '<div class="loading-spinner"></div> æµå¼ä¼ è¾“ä¸­...';
                statusEl.style.display = 'flex';
                
                // æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯
                const progressId = 'stream_' + Date.now();
                audioOutput.innerHTML = `
                    <div class="stream-progress">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <div class="loading-spinner"></div>
                            <span id="${progressId}_status">æ­£åœ¨è¿æ¥...</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="${progressId}_progress" style="width: 0%"></div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">å·²æ¥æ”¶: <span id="${progressId}_bytes">0</span> KB</small>
                        </div>
                    </div>
                `;
                
                try {
                    // æ ¹æ®æ–‡æœ¬é•¿åº¦è®¾ç½®è¶…æ—¶æ—¶é—´
                    const textLength = inputText.length;
                    let timeoutMs;
                    if (textLength > 10000) {
                        timeoutMs = 300000; // 5åˆ†é’Ÿ
                    } else if (textLength > 5000) {
                        timeoutMs = 180000; // 3åˆ†é’Ÿ
                    } else if (textLength > 1000) {
                        timeoutMs = 120000; // 2åˆ†é’Ÿ
                    } else {
                        timeoutMs = 60000;  // 1åˆ†é’Ÿ
                    }
                    
                    // åˆ›å»ºå¸¦è¶…æ—¶çš„ fetch
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
                    
                    const connectStatusEl = document.getElementById(`${progressId}_status`);
                    if (connectStatusEl) {
                        connectStatusEl.innerHTML = `æ­£åœ¨è¿æ¥... (æ–‡æœ¬é•¿åº¦: ${textLength} å­—ç¬¦ï¼Œé¢„è®¡éœ€è¦ ${Math.ceil(timeoutMs/60000)} åˆ†é’Ÿ)`;
                    }
                    
                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            api_key: document.getElementById('api_key').value,
                            model: document.getElementById('model').value,
                            input: inputText,
                            voice: voice,
                            response_format: format,
                            speed: parseFloat(speed),
                            stream_format: 'sse',  // ä½¿ç”¨çœŸæ­£çš„æµå¼ä¼ è¾“
                            download: 'false'
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        try {
                            const errorData = JSON.parse(errorText);
                            throw new Error(errorData.error || 'Unknown error');
                        } catch {
                            throw new Error(errorText || 'Unknown error');
                        }
                    }
                    
                    // æµå¼è¯»å–å“åº”
                    const reader = response.body.getReader();
                    const chunks = [];
                    let receivedBytes = 0;
                    let startTime = Date.now();
                    let audioStarted = false;
                    const bufferThreshold = 20480; // 20KB ç¼“å†²é˜ˆå€¼
                    
                    // ä½¿ç”¨æ™ºèƒ½æµå¼æ’­æ”¾å™¨
                    const playerContainer = document.createElement('div');
                    audioOutput.innerHTML = '';
                    audioOutput.appendChild(playerContainer);
                    
                    const streamingPlayer = new SmartStreamingPlayer(playerContainer, {
                        bufferSize: bufferThreshold,
                        updateInterval: 2000,
                        format: format
                    });
                    
                    streamingPlayer.updateStatus('æ­£åœ¨åˆ†æ®µç”ŸæˆéŸ³é¢‘...');
                    
                    const initialStatusEl = document.getElementById(`${progressId}_status`);
                    if (initialStatusEl) {
                        initialStatusEl.innerHTML = '<i class="bi bi-lightning-charge text-warning"></i> æ­£åœ¨åˆ†æ®µç”ŸæˆéŸ³é¢‘...';
                    }
                    
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        chunks.push(value);
                        receivedBytes += value.length;
                        
                        // è®¡ç®—é€Ÿåº¦
                        const elapsed = (Date.now() - startTime) / 1000;
                        const speed = receivedBytes / elapsed;
                        
                        // æ›´æ–°è¿›åº¦ï¼ˆä½¿ç”¨å”¯ä¸€ IDï¼‰
                        const streamBytesEl = document.getElementById(`${progressId}_bytes`);
                        const streamStatusEl = document.getElementById(`${progressId}_status`);
                        const streamProgressEl = document.getElementById(`${progressId}_progress`);
                        
                        if (streamBytesEl) {
                            streamBytesEl.textContent = (receivedBytes / 1024).toFixed(1);
                        }
                        if (streamStatusEl) {
                            streamStatusEl.innerHTML = `<i class="bi bi-lightning-charge text-warning"></i> æ­£åœ¨åˆ†æ®µç”Ÿæˆ... (${(speed / 1024).toFixed(1)} KB/s)`;
                        }
                        if (streamProgressEl) {
                            const progress = Math.min(100, (receivedBytes / 1024) * 2);
                            streamProgressEl.style.width = progress + '%';
                        }
                        
                        // æ·»åŠ éŸ³é¢‘æ•°æ®åˆ°æ™ºèƒ½æ’­æ”¾å™¨
                        if (value.length > 0) {
                            streamingPlayer.addAudioData(value.buffer);
                            
                            // é¦–æ¬¡æ’­æ”¾
                            if (!audioStarted && receivedBytes > bufferThreshold) {
                                streamingPlayer.play().then(() => {
                                    audioStarted = true;
                                    streamingPlayer.updateStatus(`å¼€å§‹æµå¼æ’­æ”¾... (${(speed / 1024).toFixed(1)} KB/s)`);
                                    
                                    const statusEl = document.getElementById(`${progressId}_status`);
                                    if (statusEl) {
                                        statusEl.innerHTML = `<i class="bi bi-play-fill text-success"></i> æ™ºèƒ½æµå¼æ’­æ”¾ä¸­... (${(speed / 1024).toFixed(1)} KB/s)`;
                                    }
                                }).catch(e => {
                                    console.log('Auto-play blocked:', e);
                                    audioStarted = true;
                                    streamingPlayer.updateStatus('ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹...');
                                    
                                    const statusEl = document.getElementById(`${progressId}_status`);
                                    if (statusEl) {
                                        statusEl.innerHTML = `<i class="bi bi-play text-warning"></i> ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹... (${(speed / 1024).toFixed(1)} KB/s)`;
                                    }
                                });
                            }
                            
                            // æ›´æ–°çŠ¶æ€
                            if (audioStarted) {
                                streamingPlayer.updateStatus(`æµå¼æ’­æ”¾ä¸­... (${(speed / 1024).toFixed(1)} KB/s)`);
                            }
                        }
                        
                    }
                    
                    // å®Œæˆæµå¼æ’­æ”¾
                    try {
                        const finalBlob = new Blob(chunks, { type: `audio/${format}` });
                        currentAudioBlob = finalBlob;
                        currentAudioUrl = URL.createObjectURL(finalBlob);
                        
                        // é€šçŸ¥æ’­æ”¾å™¨å®Œæˆ
                        streamingPlayer.finalize();
                        streamingPlayer.updateStatus(`æ’­æ”¾å®Œæˆ - ${(receivedBytes / 1024).toFixed(1)} KB`);
                        
                        console.log(`[DEBUG] Streaming completed: ${(finalBlob.size / 1024).toFixed(1)}KB`);
                        
                    } catch (e) {
                        console.log('Finalization failed:', e);
                    }
                    
                    audioActions.style.cssText = 'display: flex !important;';
                    
                    statusEl.className = 'status-message success';
                    const totalDuration = (Date.now() - startTime) / 1000;
                    statusEl.innerHTML = `<i class="bi bi-check-circle"></i> æµå¼ä¼ è¾“å®Œæˆï¼è€—æ—¶ ${totalDuration.toFixed(1)}s`;
                    
                    addToHistory(inputText, currentAudioUrl, voice, format, {
                        duration: totalDuration,
                        audioSize: receivedBytes,
                        isStreaming: true
                    });
                    
                    // æŒä¹…åŒ–åˆ°åç«¯æ•°æ®åº“
                    logToServer({
                        text_length: inputText.length,
                        voice: voice,
                        format: format,
                        speed: parseFloat(speed),
                        mode: 'æµå¼',
                        duration: totalDuration,
                        audio_size: receivedBytes,
                        status: 'success'
                    });
                    
                    if (autoDownload) {
                        downloadAudio();
                    }
                    
                } catch (error) {
                    let errorMessage = error.message;
                    let suggestion = '';
                    
                    if (error.name === 'AbortError') {
                        errorMessage = 'è¯·æ±‚è¶…æ—¶';
                        suggestion = 'æ–‡æœ¬å¤ªé•¿ï¼Œå»ºè®®åˆ†æ®µå¤„ç†æˆ–å…³é—­æµå¼æ¨¡å¼';
                    } else if (error.message.includes('timeout')) {
                        errorMessage = 'æœåŠ¡å™¨å“åº”è¶…æ—¶';
                        suggestion = 'è¯·ç¨åé‡è¯•ï¼Œæˆ–å°è¯•è¾ƒçŸ­çš„æ–‡æœ¬';
                    } else if (error.message.includes('network')) {
                        errorMessage = 'ç½‘ç»œè¿æ¥é”™è¯¯';
                        suggestion = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                    }
                    
                    statusEl.className = 'status-message error';
                    statusEl.innerHTML = `<i class="bi bi-x-circle"></i> æµå¼ä¼ è¾“å¤±è´¥: ${errorMessage}`;
                    
                    audioOutput.innerHTML = `
                        <div class="text-center p-4">
                            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                            <h5 class="mt-2 text-danger">æµå¼ä¼ è¾“å¤±è´¥</h5>
                            <p class="text-muted">${errorMessage}</p>
                            ${suggestion ? `<p class="text-info"><i class="bi bi-lightbulb"></i> ${suggestion}</p>` : ''}
                            <button class="btn btn-outline-primary mt-2" onclick="switchInputMode('text'); document.getElementById('stream_mode').checked = false;">
                                <i class="bi bi-arrow-left"></i> å°è¯•æ™®é€šæ¨¡å¼
                            </button>
                        </div>
                    `;
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-play-fill"></i> ç”Ÿæˆè¯­éŸ³';
                }
                
            } else {
                // æ™®é€šæ¨¡å¼ - ç­‰å¾…å®Œæˆåæ’­æ”¾
                statusEl.className = 'status-message loading';
                statusEl.innerHTML = '<div class="loading-spinner"></div> æ­£åœ¨ç”Ÿæˆè¯­éŸ³...';
                statusEl.style.display = 'flex';
                
                try {
                    // è®°å½•å¼€å§‹æ—¶é—´
                    const normalStartTime = Date.now();
                    
                    // æ ¹æ®æ–‡æœ¬é•¿åº¦è®¾ç½®è¶…æ—¶æ—¶é—´
                    const textLength = inputText.length;
                    let timeoutMs;
                    if (textLength > 10000) {
                        timeoutMs = 300000; // 5åˆ†é’Ÿ
                    } else if (textLength > 5000) {
                        timeoutMs = 180000; // 3åˆ†é’Ÿ
                    } else if (textLength > 1000) {
                        timeoutMs = 120000; // 2åˆ†é’Ÿ
                    } else {
                        timeoutMs = 60000;  // 1åˆ†é’Ÿ
                    }
                    
                    // åˆ›å»ºå¸¦è¶…æ—¶çš„ fetch
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
                    
                    statusEl.innerHTML = `<div class="loading-spinner"></div> æ­£åœ¨ç”Ÿæˆè¯­éŸ³... (æ–‡æœ¬é•¿åº¦: ${textLength} å­—ç¬¦ï¼Œé¢„è®¡éœ€è¦ ${Math.ceil(timeoutMs/60000)} åˆ†é’Ÿ)`;
                    
                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            api_key: document.getElementById('api_key').value,
                            model: document.getElementById('model').value,
                            input: inputText,
                            voice: voice,
                            response_format: format,
                            speed: parseFloat(speed),
                            stream_format: '',
                            download: autoDownload ? 'true' : 'false'
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        try {
                            const errorData = JSON.parse(errorText);
                            throw new Error(errorData.error || 'Unknown error');
                        } catch {
                            throw new Error(errorText || 'Unknown error');
                        }
                    }
                    
                    const blob = await response.blob();
                    currentAudioBlob = blob;
                    currentAudioUrl = URL.createObjectURL(blob);
                    
                    // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
                    audioOutput.innerHTML = `<audio controls autoplay src="${currentAudioUrl}" style="width: 100%;"></audio>`;
                    audioActions.style.cssText = 'display: flex !important;';
                    
                    const normalDuration = (Date.now() - normalStartTime) / 1000;
                    statusEl.className = 'status-message success';
                    statusEl.innerHTML = `<i class="bi bi-check-circle"></i> ç”ŸæˆæˆåŠŸï¼è€—æ—¶ ${normalDuration.toFixed(1)}s`;
                    
                    addToHistory(inputText, currentAudioUrl, voice, format, {
                        duration: normalDuration,
                        audioSize: blob.size,
                        isStreaming: false
                    });
                    
                    if (autoDownload) {
                        downloadAudio();
                    }
                    
                } catch (error) {
                    statusEl.className = 'status-message error';
                    statusEl.innerHTML = '<i class="bi bi-x-circle"></i> ç”Ÿæˆå¤±è´¥: ' + error.message;
                    audioOutput.innerHTML = '<p class="text-danger text-center mb-0"><i class="bi bi-x-circle"></i> ç”Ÿæˆå¤±è´¥</p>';
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-play-fill"></i> ç”Ÿæˆè¯­éŸ³';
                }
            }
        }
        
        // ä¸‹è½½éŸ³é¢‘
        function downloadAudio() {
            if (!currentAudioUrl) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„éŸ³é¢‘');
                return;
            }
            
            const format = document.querySelector('input[name="response_format"]:checked').value;
            const a = document.createElement('a');
            a.href = currentAudioUrl;
            a.download = 'speech.' + format;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // å¤åˆ¶éŸ³é¢‘é“¾æ¥
        function copyAudioUrl() {
            if (!currentAudioUrl) {
                alert('æ²¡æœ‰å¯å¤åˆ¶çš„é“¾æ¥');
                return;
            }
            
            navigator.clipboard.writeText(currentAudioUrl).then(() => {
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                alert('å¤åˆ¶å¤±è´¥');
            });
        }
        
        // æ·»åŠ åˆ°å†å²è®°å½•
        function addToHistory(text, audioUrl, voice, format, stats = {}) {
            const now = new Date();
            const historyItem = {
                text: text.substring(0, 100) + (text.length > 100 ? '...' : ''),
                fullTextLength: text.length,
                audioUrl: audioUrl,
                voice: voice,
                format: format,
                timestamp: now.toLocaleTimeString(),
                date: now.toLocaleDateString(),
                // ç»Ÿè®¡ä¿¡æ¯
                duration: stats.duration || 0, // ç”Ÿæˆè€—æ—¶ï¼ˆç§’ï¼‰
                audioSize: stats.audioSize || 0, // éŸ³é¢‘å¤§å°ï¼ˆå­—èŠ‚ï¼‰
                isStreaming: stats.isStreaming || false
            };
            
            history.unshift(historyItem);
            if (history.length > 20) { // ä¿ç•™æ›´å¤šå†å²
                history.pop();
            }
            
            saveHistory();
            renderHistory();
            updateStats();
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const totalGenerations = history.length;
            const totalChars = history.reduce((sum, item) => sum + (item.fullTextLength || 0), 0);
            const totalDuration = history.reduce((sum, item) => sum + (item.duration || 0), 0);
            const totalSize = history.reduce((sum, item) => sum + (item.audioSize || 0), 0);
            
            const statsHtml = `
                <div class="stats-summary mb-2 p-2 bg-light rounded" style="font-size: 0.85rem;">
                    <div class="d-flex justify-content-between flex-wrap gap-2">
                        <span><i class="bi bi-play-circle"></i> ç”Ÿæˆ: <strong>${totalGenerations}</strong> æ¬¡</span>
                        <span><i class="bi bi-fonts"></i> å­—ç¬¦: <strong>${totalChars.toLocaleString()}</strong></span>
                        <span><i class="bi bi-clock"></i> è€—æ—¶: <strong>${totalDuration.toFixed(1)}</strong>s</span>
                        <span><i class="bi bi-hdd"></i> å¤§å°: <strong>${(totalSize / 1024 / 1024).toFixed(2)}</strong>MB</span>
                    </div>
                </div>
            `;
            
            let statsEl = document.getElementById('historyStats');
            if (!statsEl) {
                statsEl = document.createElement('div');
                statsEl.id = 'historyStats';
                const historyList = document.getElementById('historyList');
                historyList.parentNode.insertBefore(statsEl, historyList);
            }
            statsEl.innerHTML = statsHtml;
        }
        
        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-muted text-center mb-0">æš‚æ— å†å²è®°å½•</p>';
                const statsEl = document.getElementById('historyStats');
                if (statsEl) statsEl.innerHTML = '';
                return;
            }
            
            historyList.innerHTML = history.map((item, index) => `
                <div class="history-item">
                    <div class="history-text" title="${item.text}">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">${item.date || ''} ${item.timestamp}</small>
                            <span class="badge ${item.isStreaming ? 'bg-info' : 'bg-secondary'}" style="font-size: 0.7rem;">
                                ${item.isStreaming ? 'æµå¼' : 'æ™®é€š'}
                            </span>
                        </div>
                        <div class="mt-1">${item.text}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">
                            <i class="bi bi-fonts"></i> ${item.fullTextLength || '?'} å­—ç¬¦
                            | <i class="bi bi-clock"></i> ${(item.duration || 0).toFixed(1)}s
                            | <i class="bi bi-hdd"></i> ${((item.audioSize || 0) / 1024).toFixed(1)}KB
                        </div>
                    </div>
                    <audio controls src="${item.audioUrl}" style="height: 40px;"></audio>
                    <div class="history-actions">
                        <button class="btn btn-sm btn-outline-secondary" onclick="downloadHistoryItem(${index})" title="ä¸‹è½½">
                            <i class="bi bi-download"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // ä¸‹è½½å†å²è®°å½•é¡¹
        function downloadHistoryItem(index) {
            const item = history[index];
            const a = document.createElement('a');
            a.href = item.audioUrl;
            a.download = 'speech.' + item.format;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // ä¿å­˜å†å²è®°å½•åˆ° localStorage
        function saveHistory() {
            // æ³¨æ„ï¼šBlob URL æ— æ³•æŒä¹…åŒ–ï¼Œè¿™é‡Œåªä¿å­˜å…ƒæ•°æ®
            // å®é™…åº”ç”¨ä¸­å¯ä»¥è€ƒè™‘ä½¿ç”¨ IndexedDB å­˜å‚¨éŸ³é¢‘æ•°æ®
        }
        
        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            // ä» localStorage åŠ è½½ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            renderHistory();
        }
        
        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                history = [];
                renderHistory();
            }
        }
    </script>
</body>
</html>
